# Cookbook for building Coreboot from Scratch for a Qemu-aarch64-Environment
# For current commands and packages see https://doc.coreboot.org/tutorial/part1.html

1. Clone the coreboot repo
$ git clone https://review.coreboot.org/coreboot
2. Download Patch for Qemu-sbsa
$ git fetch https://review.coreboot.org/coreboot refs/changes/86/79086/3 && git checkout -b change-79086 FETCH_HEAD
3. Build the toolchain for aarch64
$ make crossgcc-aarch64 CPUS=$(nproc)
4. Generate the config
$ make menuconfig
	- select Mainboard->Mainboard Model->"QEMU sbsa"
	- safe config to .config
5. (Optionally) Test config
$ make savedefconfig
$ cat defconfig
	- check output, if changes match
6. Build coreboot (as a test without a payload)
$ make

Now you have built Coreboot from Scratch, but without a payload included. This is just a step to check if anything is okay

7. Create a RUN-Script for QEMU to try the coreboot
Requirements: TFA.fd (Firmware-Blob) in a blob/ subfolder
- Run the script run.sh provided with this document
Output in the last Line should be "[EMERG] Payload not loaded."
Exit with CTRL+A, X

8. Build your initramfs.cpio File with u-root
8.1 Build u-root
$ git clone https://github.com/u-root/u-root
$ cd u-root
$ go build
8.2 Build the initramfs
- Copy the build.sh provided for u-root and run it
If you experience errors with unreachable websites, get a go tarball and install it in your home directory, and use this bin, not the system-wide-installed version

9. Build the Linux Kernel for the u-boot Payload
- Download the kernel-tarball from kernel.org and extract it with tar -xvf
- Copy the provided file "linuxboot-defconfig" to yourkernelfolder/arch/arm64/configs/
- Change the Line "CONFIG_INITRAMFS_SOURCE" to match your u-root/initramfs.cpio File-Destination
- Build your .config File with:
$ ARCH=arm64 make linuxboot_defconfig
- Copy the Linux-Kernel build.sh provided to you to your Kernel's Destination and run it
For every question, just press Enter, until it starts building the Kernel

10. Build coreboot (again, but with payload this time)
- Apply another Patch to Coreboot, to add the uefistub we need:
$ git fetch https://review.coreboot.org/coreboot refs/changes/13/78913/4 && git cherry-pick FETCH_HEAD
- Copy the Linux-Kernel-Image located in yourkernelfolder/arch/arm64/boot/Image to yourcorebootfolder/payloads/uefistub/Image
- In the Coreboot Root-directory:
$ make menuconfig
	- Payloads->Uncheck "Don't add a payload"->Payload path and filename->payloads/uefistub/build/uefistub.elf
- copy payloads/uefistub/configs/defcontig-qemu-sbsa to payloads/uefistub/configs/defconfig
$ cd payloads/uefistub
$ make defconfig -j
$ cd ../..
$ make -j # build coreboot with payload



